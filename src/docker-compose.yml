version: '3.8'

services:
  webapp:
    build: 
      context: .  # Build from current directory
      dockerfile: Dockerfile
    container_name: reprolab-webapp  # Custom container name
    ports:
      # Map HOST_PORT from .env to container port 5000
      - "${HOST_PORT:-5000}:5000"
    environment:
      # Environment variables (can be overridden)
      - FLASK_ENV=${FLASK_ENV:-production}
      - FLASK_DEBUG=${FLASK_DEBUG:-false}
      - SECRET_KEY=${SECRET_KEY:-dev-secret-change-me}
      - APP_VERSION=${APP_VERSION:-1.0.0}
      - HOSTNAME=${HOSTNAME:-reprolab-container}
      - DEPLOYMENT_TIME=${DEPLOYMENT_TIME}
      - GIT_COMMIT=${GIT_COMMIT}
    env_file:
      - .env  # Load environment variables from .env file
    volumes:
      # Mount current directory as read-only inside container
      - ./:/app:ro
    # ============================================
    # RESOURCE LIMITS (Linux cgroups)
    # ============================================
    deploy:
      resources:
        limits:
          cpus: '0.5'      # Maximum 50% of one CPU core
          memory: '256M'   # Maximum 256MB RAM
        reservations:
          cpus: '0.1'      # Guaranteed 10% of one CPU core
          memory: '128M'   # Guaranteed 128MB RAM
    # ============================================
    # HEALTH CHECK (Docker-level)
    # ============================================
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5000/health"]
      interval: 30s        # Check every 30 seconds
      timeout: 10s         # Fail if takes longer than 10s
      retries: 3           # Retry 3 times
      start_period: 40s    # Wait 40s before first check
    # ============================================
    # RESTART POLICY
    # ============================================
    restart: unless-stopped  # Auto-restart unless manually stopped
    # ============================================
    # SECURITY: Run as specific user (non-root)
    # ============================================
    user: "1000:1000"  # Run as user with UID 1000, GID 1000
